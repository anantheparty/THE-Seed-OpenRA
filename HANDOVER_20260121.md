# 交接文档 (Handover Documentation) - 2026-01-21

## 1. 今日完成工作 (Completed Tasks)
我们今天集中优化了感知层 (`IntelligenceService`) 和 `ZoneManager`，解决了地图资源识别的多个关键 BUG。

### 1.1 资源识别与评分 (Critical Fixes)
- **资源类型修正**: 实测确认 `map_query` 返回的 `ResourcesType` 为字符串 `"1"` (Ore) 和 `"2"` (Gem)，而非之前的 "ore"/"gem"。已修复解析逻辑。
- **边缘资源识别**: 修复了 DBSCAN 聚类时的索引越界问题（移除了 try-except 掩盖错误的逻辑），现在地图四个角落的矿区能被正确识别。
- **维度匹配**: 修复了 `resources[x][y]` 遍历时的长宽混淆问题，解决了右侧资源缺失和价值偏低的问题。
- **评分体系简化**: 废弃了复杂的 `strategic_value`，统一使用加权后的 `resource_value` (Resource Score) 作为唯一战术指标。
  - 公式: `Total = (OreTiles * 1.0 + GemTiles * 2.5) + (OreMines * 50 + GemMines * 150)`
- **可视化更新**: 更新了 `visualize_intel.py` 和前端 `visualize.html`，移除了过时字段，直接显示 Resource Score。

### 1.2 文档更新
- 更新了 `ZONE_MANAGER_GUIDE.md` 和 `INTELLIGENCE_SERVICE_GUIDE.md`，反映了最新的数据结构和实测结论。
- 更新了 `REFACTOR_BLUEPRINT.md`，插入了新的 **Phase 3.5**。

---

## 2. 待办任务 (Next Steps)
请重点关注 `REFACTOR_BLUEPRINT.md` 中的 **Phase 3.5: 情报与感知增强**。

### 2.1 兵力热力图 (Zone Heatmap)
- **目标**: 将 Zone 拓扑升级为热力图，不仅仅看资源，还要看兵力分布。
- **实现思路**:
  - 在 `ZoneManager.update_bases` 中，除了统计建筑，还需要统计所有 `Mobile` 单位。
  - 建立一个简单的战力评估模型 (e.g., Tank=100, Infantry=10)，计算每个 Zone 内的三方势力对比。
  - 更新 `ZoneInfo.owner_faction` 的判定逻辑：不再仅看建筑，当建筑相等时，看兵力控制权。

### 2.2 迷雾状态 (Fog Awareness)
- **目标**: 知道哪些 Zone 是“已探索但无视野”，哪些是“完全未知”。
- **实现思路**:
  - 遍历 `self.zones`，对每个 Zone 的 `center` 调用 `GameAPI.fog_query`。
  - 存储 `is_visible` 和 `is_explored` 状态。
  - 战略意义：优先派侦察兵去高价值且 `is_explored=False` 的区域。

### 2.3 运营专家 (Economy Agent)
- 完成 Phase 3.5 后，继续推进 Phase 3 的 Economy Agent 开发。

---

## 3. 注意事项 (Notes)
- **Socket Buffer**: `GameAPI._receive_data` 的 buffer 已扩大到 32KB 并加了 timeout，以应对大地图数据的完整性问题。如果后续遇到大地图卡顿，可检查此处。
- **坐标系**: 始终牢记 OpenRA 的资源数组是 `[x][y]` (Column-Major)，且 `len(resources) == Width`。
  - **注意**: `socket-apis.md` 中的示例数据展示的是 `[[Row0], [Row1], [Row2]]` 这种 Row-Major (即 `[y][x]`) 的 JSON 格式，但在 Python 实测中 `map_query` 返回的数组结构是 Column-Major (即 `len=Width`)。开发者需以实测代码 (`scripts/check_resource_types.py`) 为准。

请基于 `dev` 分支继续开发。祝顺利！
